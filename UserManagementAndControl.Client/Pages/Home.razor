@page "/"
@using Nesco.SignalRUserManagement.Client.Authorization.Services
@using Nesco.SignalRUserManagement.Client.Services
@using UserManagementAndControl.Client.Services
@using UserManagementAndControl.Client.Extensions
@inject AuthService AuthService
@inject UserConnectionClient ConnectionClient
@inject MethodInvocationLogger InvocationLogger
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>SignalR Client Demo</PageTitle>

<style>
    .table-responsive thead.sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .method-log-table td {
        vertical-align: middle;
    }
</style>

@if (!_isAuthenticated)
{
    <div class="text-center mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Checking authentication...</p>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1>SignalR User Management & Control Demo</h1>
            <p>This Blazor WebAssembly client demonstrates the SignalR User Management package with method invocation support.</p>
        </div>
        <div>
            <span class="me-3">Welcome, <strong>@_username</strong></span>
            <button class="btn btn-outline-danger btn-sm" @onclick="HandleLogout">Logout</button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">User Management Hub</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                @if (_isConnected)
                                {
                                    <span class="badge bg-success">Connected</span>
                                }
                                else if (_isConnecting || _isReconnecting)
                                {
                                    <span class="badge bg-warning">
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                        @(_isConnecting ? "Connecting..." : "Reconnecting...")
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Disconnected</span>
                                }
                            </td>
                        </tr>
                        @if (_isConnected && !string.IsNullOrEmpty(_connectionId))
                        {
                            <tr>
                                <td><strong>Connection ID:</strong></td>
                                <td><code class="text-primary">@_connectionId</code></td>
                            </tr>
                        }
                        <tr>
                            <td><strong>Hub URL:</strong></td>
                            <td><small>@(ConnectionClient.ConfiguredHubUrl ?? "Not configured")</small></td>
                        </tr>
                        <tr>
                            <td><strong>Auto-Reconnect:</strong></td>
                            <td>
                                <span class="badge bg-info">Enabled</span>
                                <small class="text-muted ms-2">Retry delays: 0s, 2s, 5s, 10s, 30s</small>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Registered Client Methods</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">The server can invoke <strong>7 methods</strong> on this client:</p>
                    <p class="mb-0">
                        <code>Ping</code>, <code>Echo</code>, <code>Alert</code>, <code>Navigate</code>, <code>GetClientInfo</code>, <code>Calculate</code>, <code>GetLargeData</code>
                    </p>
                    <hr class="my-2"/>
                    <small class="text-muted">See the API Reference section below for details on parameters and responses.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">API Reference - Available Methods</h5>
                </div>
                <div class="card-body">
                    <div class="accordion">
                        <!-- Ping -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(_expandedMethod != "Ping" ? "collapsed" : "")" type="button" @onclick="@(() => ToggleMethod("Ping"))">
                                    <code class="me-2">Ping</code> <span class="text-muted">- Connectivity check</span>
                                </button>
                            </h2>
                            @if (_expandedMethod == "Ping")
                            {
                                <div class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p><strong>Description:</strong> Simple connectivity check that returns "Pong" with a timestamp.</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Parameters</h6>
                                                <p class="text-muted mb-0"><em>None required</em></p>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Response</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "message": "Pong",
  "timestamp": "2024-01-15T10:30:00Z"
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Echo -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(_expandedMethod != "Echo" ? "collapsed" : "")" type="button" @onclick="@(() => ToggleMethod("Echo"))">
                                    <code class="me-2">Echo</code> <span class="text-muted">- Echo back a message</span>
                                </button>
                            </h2>
                            @if (_expandedMethod == "Echo")
                            {
                                <div class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p><strong>Description:</strong> Echoes back the provided message with a received timestamp.</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Parameters</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "Message": "Hello from server!"
}</code></pre>
                                                <small class="text-muted"><code>Message</code> (string) - The message to echo back</small>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Response</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "echo": "Hello from server!",
  "receivedAt": "2024-01-15T10:30:00Z"
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Alert -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(_expandedMethod != "Alert" ? "collapsed" : "")" type="button" @onclick="@(() => ToggleMethod("Alert"))">
                                    <code class="me-2">Alert</code> <span class="text-muted">- Send an alert notification</span>
                                </button>
                            </h2>
                            @if (_expandedMethod == "Alert")
                            {
                                <div class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p><strong>Description:</strong> Sends an alert notification to the client. Returns acknowledgment.</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Parameters</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "Title": "Warning",
  "Message": "This is an alert!"
}</code></pre>
                                                <small class="text-muted">
                                                    <code>Title</code> (string) - Alert title<br/>
                                                    <code>Message</code> (string) - Alert message body
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Response</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "acknowledged": true,
  "title": "Warning"
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Navigate -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(_expandedMethod != "Navigate" ? "collapsed" : "")" type="button" @onclick="@(() => ToggleMethod("Navigate"))">
                                    <code class="me-2">Navigate</code> <span class="text-muted">- Request client navigation</span>
                                </button>
                            </h2>
                            @if (_expandedMethod == "Navigate")
                            {
                                <div class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p><strong>Description:</strong> Requests the client to navigate to a specified URL.</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Parameters</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "Url": "/dashboard"
}</code></pre>
                                                <small class="text-muted"><code>Url</code> (string) - The URL to navigate to</small>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Response</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "willNavigate": true,
  "url": "/dashboard"
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- GetClientInfo -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(_expandedMethod != "GetClientInfo" ? "collapsed" : "")" type="button" @onclick="@(() => ToggleMethod("GetClientInfo"))">
                                    <code class="me-2">GetClientInfo</code> <span class="text-muted">- Get client information</span>
                                </button>
                            </h2>
                            @if (_expandedMethod == "GetClientInfo")
                            {
                                <div class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p><strong>Description:</strong> Returns information about the client platform and environment.</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Parameters</h6>
                                                <p class="text-muted mb-0"><em>None required</em></p>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Response</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "platform": "Blazor WebAssembly",
  "userAgent": "UserManagementAndControl.Client",
  "timestamp": "2024-01-15T10:30:00Z",
  "timezone": "(UTC+00:00) Coordinated Universal Time"
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Calculate -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(_expandedMethod != "Calculate" ? "collapsed" : "")" type="button" @onclick="@(() => ToggleMethod("Calculate"))">
                                    <code class="me-2">Calculate</code> <span class="text-muted">- Perform arithmetic operations</span>
                                </button>
                            </h2>
                            @if (_expandedMethod == "Calculate")
                            {
                                <div class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p><strong>Description:</strong> Performs arithmetic operations (+, -, *, /) on two numbers.</p>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Parameters</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "A": 10,
  "B": 5,
  "Operation": "+"
}</code></pre>
                                                <small class="text-muted">
                                                    <code>A</code> (number) - First operand<br/>
                                                    <code>B</code> (number) - Second operand<br/>
                                                    <code>Operation</code> (string) - One of: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Response</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "a": 10,
  "b": 5,
  "operation": "+",
  "result": 15
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- GetLargeData -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button @(_expandedMethod != "GetLargeData" ? "collapsed" : "")" type="button" @onclick="@(() => ToggleMethod("GetLargeData"))">
                                    <code class="me-2">GetLargeData</code> <span class="text-muted">- Generate large dataset (tests file upload)</span>
                                </button>
                            </h2>
                            @if (_expandedMethod == "GetLargeData")
                            {
                                <div class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p><strong>Description:</strong> Generates a large dataset that exceeds the direct SignalR message size limit. This triggers the file upload mechanism where the client uploads the response to the server via HTTP and returns the file path.</p>
                                        <div class="alert alert-info py-2 mb-3">
                                            <small><strong>File Upload Test:</strong> With default settings (MaxDirectDataSizeBytes = 32KB), ~100+ items will trigger file upload. Try <code>ItemCount: 500</code> for a clear test.</small>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Parameters</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "ItemCount": 500
}</code></pre>
                                                <small class="text-muted">
                                                    <code>ItemCount</code> (number) - Number of items to generate. Default: 1000
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Response</h6>
                                                <pre class="bg-light p-2 mb-0"><code>{
  "itemCount": 500,
  "generatedAt": "2024-01-15T10:30:00Z",
  "approximateSizeBytes": 185000,
  "items": [
    {
      "id": 1,
      "name": "Item_1_abc123...",
      "description": "...",
      "value": 1234.56,
      "timestamp": "...",
      "tags": ["tag0", "category0"],
      "metadata": {...}
    },
    ...
  ]
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Client-to-Server Methods (Custom Hub Methods)</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">These methods are called <strong>from the client to the server</strong> via the custom <code>AppHub</code>. Click a button to test:</p>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><code>GetServerTime</code></h6>
                                    <p class="card-text small text-muted">Gets the current server time in ISO 8601 format.</p>
                                    <button class="btn btn-primary btn-sm" @onclick="CallGetServerTime" disabled="@(!_isConnected || _isCallingServerMethod)">
                                        @if (_isCallingServerMethod && _currentServerMethod == "GetServerTime")
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Call GetServerTime
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><code>Echo</code></h6>
                                    <p class="card-text small text-muted">Echoes a message back from the server.</p>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="text" class="form-control" placeholder="Enter message" @bind="_echoMessage" />
                                    </div>
                                    <button class="btn btn-primary btn-sm" @onclick="CallEcho" disabled="@(!_isConnected || _isCallingServerMethod)">
                                        @if (_isCallingServerMethod && _currentServerMethod == "Echo")
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Call Echo
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><code>BroadcastMessage</code></h6>
                                    <p class="card-text small text-muted">Broadcasts a message to all connected clients.</p>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="text" class="form-control" placeholder="Enter broadcast message" @bind="_broadcastMessage" />
                                    </div>
                                    <button class="btn btn-warning btn-sm" @onclick="CallBroadcast" disabled="@(!_isConnected || _isCallingServerMethod)">
                                        @if (_isCallingServerMethod && _currentServerMethod == "Broadcast")
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Broadcast to All
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><code>SendNotificationToUser</code></h6>
                                    <p class="card-text small text-muted">Sends a notification to a specific user.</p>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="text" class="form-control" placeholder="User ID" @bind="_notificationUserId" />
                                    </div>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="text" class="form-control" placeholder="Title" @bind="_notificationTitle" />
                                        <input type="text" class="form-control" placeholder="Message" @bind="_notificationMessage" />
                                    </div>
                                    <button class="btn btn-info btn-sm" @onclick="CallSendNotification" disabled="@(!_isConnected || _isCallingServerMethod)">
                                        @if (_isCallingServerMethod && _currentServerMethod == "SendNotification")
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Send Notification
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_serverMethodResult))
                    {
                        <div class="mt-3">
                            <h6>Last Result:</h6>
                            <pre class="bg-light p-2 mb-0"><code>@_serverMethodResult</code></pre>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_serverMethodError))
                    {
                        <div class="mt-3">
                            <div class="alert alert-danger mb-0">
                                <strong>Error:</strong> @_serverMethodError
                            </div>
                        </div>
                    }

                    @if (_receivedMessages.Any())
                    {
                        <div class="mt-3">
                            <h6>Received Messages (Broadcasts & Notifications):</h6>
                            <div class="bg-dark text-light p-2 rounded" style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">
                                @foreach (var msg in _receivedMessages)
                                {
                                    <div>@msg</div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Method Invocation Log</h5>
                    <button class="btn btn-sm btn-outline-dark" @onclick="ClearLog">Clear Log</button>
                </div>
                <div class="card-body">
                    @if (!_methodLogs.Any())
                    {
                        <div class="alert alert-info mb-0">
                            <p class="mb-0">No methods have been invoked yet. Use the server's SignalR Test page to invoke methods on this client.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-hover method-log-table">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th style="width: 100px;">Time</th>
                                        <th style="width: 150px;">Method</th>
                                        <th style="width: 200px;">Parameters</th>
                                        <th>Result</th>
                                        <th style="width: 80px;">Duration</th>
                                        <th style="width: 60px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in _methodLogs)
                                    {
                                        <tr class="@(log.Success ? "" : "table-danger")">
                                            <td><small>@log.Timestamp.ToString("HH:mm:ss.fff")</small></td>
                                            <td><code class="text-primary">@log.MethodName</code></td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(log.Parameter))
                                                {
                                                    <small class="text-muted" style="font-family: monospace; font-size: 0.85em;">
                                                        @(log.Parameter.Length > 50 ? log.Parameter.Substring(0, 50) + "..." : log.Parameter)
                                                    </small>
                                                }
                                                else
                                                {
                                                    <em class="text-muted">none</em>
                                                }
                                            </td>
                                            <td>
                                                @if (log.Success)
                                                {
                                                    <small class="text-success" style="font-family: monospace; font-size: 0.85em;">
                                                        @(log.Result != null && log.Result.Length > 100 ? log.Result.Substring(0, 100) + "..." : log.Result)
                                                    </small>
                                                }
                                                else
                                                {
                                                    <small class="text-danger">@log.Error</small>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge @(log.Duration.TotalMilliseconds < 100 ? "bg-success" : log.Duration.TotalMilliseconds < 500 ? "bg-warning" : "bg-danger")">
                                                    @log.Duration.TotalMilliseconds.ToString("F0")ms
                                                </span>
                                            </td>
                                            <td>
                                                @if (log.Success)
                                                {
                                                    <span class="badge bg-success">OK</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">ERR</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Showing last @_methodLogs.Count() invocations (max 50)</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Testing Instructions</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading">How to Test</h6>
                        <ol class="mb-0">
                            <li>Ensure the connection status shows <span class="badge bg-success">Connected</span></li>
                            <li>Navigate to the server application at <code>http://localhost:5000/signalr-test</code></li>
                            <li>You should see this client listed in the "Connected Users" section</li>
                            <li>Use the "Invoke Method" form to call any of the registered methods</li>
                            <li>Results will be displayed both on the server test page and in the log above</li>
                        </ol>
                    </div>

                    <div class="alert alert-warning mb-0">
                        <h6 class="alert-heading">Auto-Reconnect Feature</h6>
                        <p class="mb-2">The client will automatically connect and reconnect:</p>
                        <ul class="mb-0">
                            <li><strong>Auto-Connect on Login:</strong> SignalR connects automatically when you log in</li>
                            <li><strong>Connection Drop:</strong> If the connection drops, status shows <span class="badge bg-warning">Reconnecting...</span> with progressive backoff</li>
                            <li><strong>Retry delays:</strong> 0s, 2s, 5s, 10s, 30s (continuous retry every 30s if all attempts fail)</li>
                            <li><strong>No Manual Refresh Required:</strong> Once the server is back online, the client will automatically connect</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _isAuthenticated;
    private string _username = string.Empty;
    private bool _isConnected;
    private bool _isConnecting;
    private bool _isReconnecting;
    private string _connectionId = string.Empty;
    private System.Threading.Timer? _statusTimer;
    private System.Threading.Timer? _reconnectTimer;
    private IEnumerable<MethodInvocationLog> _methodLogs = Enumerable.Empty<MethodInvocationLog>();
    private string? _expandedMethod;

    // Client-to-server method call state
    private bool _isCallingServerMethod;
    private string _currentServerMethod = string.Empty;
    private string _serverMethodResult = string.Empty;
    private string _serverMethodError = string.Empty;
    private string _echoMessage = "Hello from client!";
    private string _broadcastMessage = "Broadcast message from client";
    private string _notificationUserId = string.Empty;
    private string _notificationTitle = "Notification";
    private string _notificationMessage = "This is a test notification";
    private List<string> _receivedMessages = new();

    private void ToggleMethod(string methodName)
    {
        _expandedMethod = _expandedMethod == methodName ? null : methodName;
    }

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to method completion event for handling server-initiated logout
        ConnectionClient.MethodCompleted += OnMethodCompleted;

        // Subscribe to method execution completed event for logging invocations
        ConnectionClient.MethodExecutionCompleted += OnMethodExecutionCompleted;

        // Check authentication
        _isAuthenticated = AuthService.IsAuthenticated;
        if (!_isAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        _username = AuthService.CurrentUser.Identity?.Name ?? "Unknown";

        // Subscribe to events BEFORE connecting
        ConnectionClient.ConnectionStatusChanged += OnConnectionStatusChanged;
        ConnectionClient.Reconnecting += OnReconnecting;
        ConnectionClient.Reconnected += OnReconnected;
        InvocationLogger.OnLogAdded += OnLogAdded;

        // Load initial logs
        RefreshLogs();

        // Check initial connection state
        UpdateConnectionState();

        // Set up a timer to periodically check connection status
        _statusTimer = new System.Threading.Timer(async _ =>
        {
            UpdateConnectionState();
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));

        // Auto-connect to SignalR if not already connected
        if (!ConnectionClient.IsConnected && !string.IsNullOrEmpty(AuthService.AccessToken))
        {
            await StartConnection();
        }
    }

    private void OnMethodCompleted(string methodName, bool success)
    {
        // Handle server-initiated logout after response is sent
        if (methodName == "Logout")
        {
            InvokeAsync(async () =>
            {
                await HandleLogout();
                StateHasChanged();
            });
        }
    }

    private void OnMethodExecutionCompleted(string methodName, object? parameter, object? result, TimeSpan duration, Exception? error)
    {
        // Log the method invocation to the MethodInvocationLogger
        InvocationLogger.LogInvocation(methodName, parameter, result, duration, error);
    }

    private async Task StartConnection()
    {
        _isConnecting = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            // HubUrl is pre-configured in Program.cs
            await ConnectionClient.StartAsync(
                accessTokenProvider: () => Task.FromResult(AuthService.AccessToken!));

            // Register handlers for receiving broadcasts and notifications from AppHub
            RegisterCustomHubHandlers();
        }
        catch (Exception ex)
        {
            Console.WriteLine($">>> [Home] Connection failed: {ex.Message}");
            _isConnecting = false;

            // Start continuous retry timer
            StartContinuousRetry();
        }
    }

    private void RegisterCustomHubHandlers()
    {
        // Use the On method from UserConnectionClient which properly wraps HubConnection.On
        // Handle broadcast messages from AppHub.BroadcastMessage
        ConnectionClient.On<System.Text.Json.JsonElement>("ReceiveBroadcast", async (data) =>
        {
            var message = $"[{DateTime.Now:HH:mm:ss}] Broadcast received: {data.GetRawText()}";
            _receivedMessages.Insert(0, message);
            if (_receivedMessages.Count > 10) _receivedMessages.RemoveAt(_receivedMessages.Count - 1);
            await InvokeAsync(StateHasChanged);
        });

        // Handle notifications from AppHub.SendNotificationToUser
        ConnectionClient.On<System.Text.Json.JsonElement>("ReceiveNotification", async (data) =>
        {
            var message = $"[{DateTime.Now:HH:mm:ss}] Notification received: {data.GetRawText()}";
            _receivedMessages.Insert(0, message);
            if (_receivedMessages.Count > 10) _receivedMessages.RemoveAt(_receivedMessages.Count - 1);
            await InvokeAsync(StateHasChanged);
        });
    }

    private void StartContinuousRetry()
    {
        // Dispose existing timer if any
        _reconnectTimer?.Dispose();

        Console.WriteLine(">>> [Home] Starting continuous retry timer (every 30 seconds)");

        // Create timer that fires every 30 seconds
        _reconnectTimer = new System.Threading.Timer(async _ =>
        {
            // Only retry if still disconnected
            if (!ConnectionClient.IsConnected && AuthService.IsAuthenticated)
            {
                Console.WriteLine(">>> [Home] Continuous retry attempt...");
                try
                {
                    // HubUrl is pre-configured in Program.cs
                    await ConnectionClient.StartAsync(
                        accessTokenProvider: () => Task.FromResult(AuthService.AccessToken!));
                }
                catch (Exception retryEx)
                {
                    Console.WriteLine($">>> [Home] Continuous retry failed: {retryEx.Message}");
                }
            }
            else if (ConnectionClient.IsConnected)
            {
                Console.WriteLine(">>> [Home] Connection successful, stopping continuous retry timer");
                _reconnectTimer?.Dispose();
                _reconnectTimer = null;
            }
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task HandleLogout()
    {
        await ConnectionClient.StopAsync();
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    private void UpdateConnectionState()
    {
        _isConnected = ConnectionClient.IsConnected;

        if (_isConnected)
        {
            _connectionId = ConnectionClient.ConnectionId ?? string.Empty;
            _isConnecting = false;
        }
        else
        {
            _connectionId = string.Empty;
        }
    }

    private async void OnConnectionStatusChanged(bool isConnected)
    {
        _isConnecting = false;

        // If connected, stop continuous retry timer
        if (isConnected && _reconnectTimer != null)
        {
            Console.WriteLine(">>> [Home] Connection established, stopping continuous retry timer");
            _reconnectTimer?.Dispose();
            _reconnectTimer = null;
        }

        UpdateConnectionState();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnReconnecting()
    {
        _isReconnecting = true;
        await InvokeAsync(StateHasChanged);
    }

    private async void OnReconnected(string? connectionId)
    {
        _isReconnecting = false;
        UpdateConnectionState();
        await InvokeAsync(StateHasChanged);
    }

    private async void OnLogAdded()
    {
        RefreshLogs();
        await InvokeAsync(StateHasChanged);
    }

    private void RefreshLogs()
    {
        _methodLogs = InvocationLogger.GetLogs();
    }

    private void ClearLog()
    {
        InvocationLogger.Clear();
        RefreshLogs();
    }

    // Client-to-server method calls using extension methods
    private async Task CallGetServerTime()
    {
        await CallServerMethodAsync("GetServerTime", async () =>
        {
            var connection = ConnectionClient.Connection;
            if (connection == null) throw new InvalidOperationException("Not connected");
            return await connection.GetServerTimeAsync();
        });
    }

    private async Task CallEcho()
    {
        await CallServerMethodAsync("Echo", async () =>
        {
            var connection = ConnectionClient.Connection;
            if (connection == null) throw new InvalidOperationException("Not connected");
            return await connection.EchoAsync(_echoMessage);
        });
    }

    private async Task CallBroadcast()
    {
        await CallServerMethodAsync("Broadcast", async () =>
        {
            var connection = ConnectionClient.Connection;
            if (connection == null) throw new InvalidOperationException("Not connected");
            await connection.BroadcastMessageAsync(_broadcastMessage);
            return "Broadcast sent successfully";
        });
    }

    private async Task CallSendNotification()
    {
        if (string.IsNullOrWhiteSpace(_notificationUserId))
        {
            _serverMethodError = "Please enter a User ID";
            return;
        }

        await CallServerMethodAsync("SendNotification", async () =>
        {
            var connection = ConnectionClient.Connection;
            if (connection == null) throw new InvalidOperationException("Not connected");
            await connection.SendNotificationToUserAsync(_notificationUserId, _notificationTitle, _notificationMessage);
            return $"Notification sent to user {_notificationUserId}";
        });
    }

    private async Task CallServerMethodAsync(string methodName, Func<Task<string>> action)
    {
        _isCallingServerMethod = true;
        _currentServerMethod = methodName;
        _serverMethodResult = string.Empty;
        _serverMethodError = string.Empty;
        StateHasChanged();

        try
        {
            var result = await action();
            _serverMethodResult = result;
        }
        catch (Exception ex)
        {
            _serverMethodError = ex.Message;
        }
        finally
        {
            _isCallingServerMethod = false;
            _currentServerMethod = string.Empty;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        // Dispose timers
        _statusTimer?.Dispose();
        _reconnectTimer?.Dispose();

        // Unsubscribe from events
        ConnectionClient.ConnectionStatusChanged -= OnConnectionStatusChanged;
        ConnectionClient.Reconnecting -= OnReconnecting;
        ConnectionClient.Reconnected -= OnReconnected;
        ConnectionClient.MethodCompleted -= OnMethodCompleted;
        ConnectionClient.MethodExecutionCompleted -= OnMethodExecutionCompleted;
        InvocationLogger.OnLogAdded -= OnLogAdded;
    }
}
