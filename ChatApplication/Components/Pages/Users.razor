@page "/users"
@inject AuthService AuthService
@inject ChatService ChatService
@inject NavigationManager Navigation
@implements IDisposable

<div class="users-page">
    <div class="page-header">
        <button class="back-button" @onclick="GoBack">
            <span>‚Üê</span>
        </button>
        <h1>New Chat</h1>
    </div>

    @if (_isLoading)
    {
        <div class="loading-container">
            <p>Loading users...</p>
        </div>
    }
    else if (!_users.Any())
    {
        <div class="empty-state">
            <p>No other users found</p>
        </div>
    }
    else
    {
        <div class="users-list">
            @foreach (var user in _users)
            {
                <UserListItem User="user" OnClick="StartConversation" />
            }
        </div>
    }
</div>

@code {
    private List<UserDto> _users = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        ChatService.OnForceLogout += OnForceLogout;
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            _users = await ChatService.GetUsersAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Users] Error loading: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task StartConversation(UserDto user)
    {
        var conversation = await ChatService.StartConversationAsync(user.Id);
        if (conversation != null)
        {
            Navigation.NavigateTo($"/chat/{conversation.Id}");
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void OnForceLogout(ForceLogoutEvent evt)
    {
        Console.WriteLine($"[Users] ForceLogout: {evt.Reason}");
        InvokeAsync(() => Navigation.NavigateTo("/"));
    }

    public void Dispose()
    {
        ChatService.OnForceLogout -= OnForceLogout;
    }
}
